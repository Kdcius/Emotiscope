<html>
<head>
	<style>
		#log{
			width: 100%;
			height: 200px;
			overflow: auto;
			border: 1px solid black;
		}
	</style>
</head>

<body>
	<div id="output"></div>
	<button onclick="send_ping();">PING</button>

	<div id="log"></div>

	<script>
		var emotiscope_connected = false;
		var ws = null;
		var attempt_to_reach_emotiscope_interval = null;

		function add_to_log(message){
			var log = document.getElementById('log');
			log.innerHTML = message + "<br>" + log.innerHTML;
			log.scrollTop = 0;
		}

		function send_ping() {
			wstx("ping");
		}

		function wstx(message){
			ws.send(message);
			console.log("TX: " + message);
			add_to_log("TX: " + message);
		}

		function wsrx(message){
			console.log("RX: " + message);
			add_to_log("RX: " + message);

			if( check_auto_reply_table(message) == true ){
				return;
			}
			else{
				var message_items = message.split("|");

				if( message_items[0] == "emotiscope" ){
					emotiscope_connected = true;
					clearInterval(attempt_to_reach_emotiscope_interval);
				}
			}
		}

		function attempt_to_reach_emotiscope() {
			if(emotiscope_connected == false){
				// Send a message to the server
				wstx("emotiscope?");
			}
		}

		function connect_to_websocket(server_ip) {
			ws = new WebSocket(server_ip);

			ws.onopen = function() {
				console.log("Websockets connection established");
				emotiscope_connected = false;

				attempt_to_reach_emotiscope();
				attempt_to_reach_emotiscope_interval = setInterval(attempt_to_reach_emotiscope, 250);
			};

			ws.onmessage = function(event) {
				wsrx(event.data);
			};

			ws.onclose = function() {
				console.log("Websockets connection closed");
			};

			ws.onerror = function(event) {
				console.log("Websockets error: " + event);
			};
		}

		connect_to_websocket("ws://192.168.86.140:80/ws");

		var output = document.getElementById('output');
		output.innerHTML = "Hello, World!";

	</script>
</body>
</html>